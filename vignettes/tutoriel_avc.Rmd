---
title: "Exemple d'étude possible avec sndsTools"
author: "sndsTools"
date: "2026-01-11"
output:
  html_document:
    bookdown::html_document2:
      base_format: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{Exemple d'étude possible avec sndsTools}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
resources:
- name: img
  files: img/
---

Cette page présente un exemple type d'utilisation des fonctions de `sndsTools` pour étudier les données du SNDS.

Le cas d'étude porte sur les patients hospitalisés pour un accident vasculaire cérébral (AVC) en 2024.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  warning = FALSE
)
```

# Contexte de l'étude

Dans le cadre de cette étude, nous souhaitons analyser les parcours de soins des patients hospitalisés pour un AVC au cours de l'année 2024. Nous utiliserons les fonctions disponibles dans `sndsTools` pour extraire et analyser les données pertinentes.

::: {.alert .alert-warning}
Cette étude est un exemple pédagogique de l'utilisation du package `sndsTools`. Elle ne constitue en aucun cas une étude réelle valide scientifiquement concernant les patients hospitalisés pour un AVC.
:::

Les objectifs de cette étude sont :

1. Identifier les patients avec une hospitalisation pour AVC en 2024 (codes CIM-10 : I61, I62, I63, I64) via la fonction `extract_hospital_stays()`

2. Récupérer leurs identifiants complets via `retrieve_all_psa_from_psa()`

3. Extraire leurs consultations médicales en ville via `extract_consultations_erprsf()`

4. Extraire leurs Affections de Longue Durée (ALD) via `extract_long_term_disease()`

5. Extraire leurs prescriptions médicamenteuses en ville
    via `extract_drug_dispenses()`

6. Nettoyer et fermer la connexion à la base de données

## Prérequis

Avant de commencer, assurez-vous d'avoir :

- Une connexion à la base de données Oracle du SNDS sur le portail de la CNAM

- Le code du package `sndsTools` [copié sur le portail](https://sndstoolers.github.io/sndsTools/articles/sndsTools.html#sur-le-portail-cnam)


::: {.alert .alert-info}
Cette vignette peut être exécutée hors du portail CNAM. Dans ce cas, des données fictives sont générées pour illustrer les étapes de l'étude.
:::

```{r setup}
# Charger les packages nécessaires
if (dir.exists("~/sasdata1")) {
    # sur le portail CNAM
    source("../sndsTools_all.R")
    # Établir la connexion à la base de données
    conn <- connect_oracle()
} else {
    # hors portail CNAM (ex. pour construire cette vignette)
    library(sndsTools)
    # Charge des données fictives
    conn <- create_mock_database(
      n_patients = 100,
      year = 2024,
      start_date = as.Date("2024-01-01"),
      end_date = as.Date("2024-12-31")
    )
}
# packages utiles pour l'analyse
library(dplyr)
library(lubridate)
library(knitr)
```

## Étape 1 : Extraction des hospitalisations pour AVC

Nous commençons par extraire les séjours hospitaliers avec un diagnostic principal d'AVC en utilisant la fonction `extract_hospital_stays()`.

Les [codes CIM-10 pour les AVC](https://fr.wikipedia.org/wiki/CIM-10_Chapitre_09_:_Maladies_de_l%27appareil_circulatoire) sont I61 (hémorragie intracérébrale), I62 (autres hémorragies intracrâniennes non traumatiques), I63 (infarctus cérébral) et I64 (accident vasculaire cérébral non précisé).

```{r extract_avc_hospitalisations}
# Définir la période d'étude - année 2024
start_date <- as.Date("2024-01-01")
end_date <- as.Date("2024-12-31")

# Codes CIM-10 pour les AVC
codes_avc <- c("I61", "I62", "I63", "I64")

# Extraire les séjours avec diagnostics d'AVC
extract_hospital_stays(
  start_date = start_date,
  end_date = end_date,
  dp_cim10_codes_filter = codes_avc,
  or_dr_with_same_codes_filter = TRUE,  # Inclure les diagnostics reliés
  or_da_with_same_codes_filter = FALSE,  # Exclure diagnostics associés similaires
  and_da_with_other_codes_filter = FALSE,  # Exclure diagnostics associés différents
  da_cim10_codes_filter = NULL,  # Pas de filtre sur diagnostics associés
  patients_ids_filter = NULL,  # Extraire tous les patients
  output_table_name = "TMP_SEJOURS_AVC",  # Stocker en table Oracle
  conn = conn
)

# Récupérer un aperçu des données
sejours_avc_head <- dplyr::tbl(conn, "TMP_SEJOURS_AVC") |>
  head(5) |>
  dplyr::collect()

kable(sejours_avc_head)

# Analyser la répartition par type d'AVC
avc_par_type <- dplyr::tbl(conn, "TMP_SEJOURS_AVC") |>
  dplyr::count(DGN_PAL, sort = TRUE) |>
  dplyr::mutate(pourcentage = round(n / sum(n) * 100, 1)) |>
  dplyr::collect()
kable(avc_par_type)
```

## Étape 2 : Identification des patients uniques

À partir des séjours, nous identifions les patients uniques en [récupérant leurs identifiants uniques `BEN_NIR_ANO`](https://documentation-snds.health-data-hub.fr/snds/fiches/fiche_beneficiaire.html) dans le référentiel des bénéficiaires en utilisant `retrieve_all_psa_from_psa()`.

```{r patients_identifiants}
# Créer une table temporaire des pseudo-NIR des patients avec AVC
patients_psa_avc <- dplyr::tbl(conn, "TMP_SEJOURS_AVC") |>
  dplyr::select(BEN_NIR_PSA = NIR_ANO_17) |>
  dplyr::distinct() |>
  dplyr::collect()

# Sauvegarder temporairement dans Oracle
DBI::dbWriteTable(conn, "TMP_PATIENTS_AVC_PSA", patients_psa_avc, overwrite = TRUE)

# Récupérer tous les identifiants patients associés
patients_identifiants_avc <- retrieve_all_psa_from_psa(
  ben_table_name = "TMP_PATIENTS_AVC_PSA",
  conn = conn,
  output_table_name = NULL,  # Retourner data.frame
  check_arc_table = FALSE # Pas de recherche dans la table d'identifiant archivée,
)

# Filtrer les patients avec des critères de qualité
patients_avc_qualite <- patients_identifiants_avc |>
  filter(
    !psa_w_multiple_idt_or_nir,  # Éviter les PSA multiples
    cdi_nir_00,                   # NIR non fictifs
    nir_ano_defined,              # NIR anonyme défini
    !birth_date_variation,        # Pas de variation date naissance
    !sex_variation               # Pas de variation sexe
  )
# Préparer les identifiants pour les extractions ultérieures
patients_ids_filter <- patients_avc_qualite |>
  select(BEN_IDT_ANO, BEN_NIR_PSA, BEN_RNG_GEM) |>
  distinct()

paste("Nombre de patients uniques avec AVC :", nrow(patients_avc_qualite))
```

## Étape 3 : Extraction des consultations médicales

Nous extrayons toutes les consultations médicales en ville de ces patients en utilisant `extract_consultations_erprsf()`.

```{r extract_consultations_avc}
# Extraire toutes les consultations des patients avec AVC
extract_consultations_erprsf(
  start_date = start_date,
  end_date = end_date,
  pse_spe_filter = c(32, 10, 47, 3),  # Spécalités neuro ou cardio
  prestation_filter = NULL,  # Toutes les prestations
  analyse_couts = FALSE,  # Filtrer les majorations
  dis_dtd_lag_months = 6,  # Décalage standard 6 mois
  patients_ids_filter = patients_ids_filter,
  output_table_name = "TMP_CONSULTATIONS_AVC",  # Stocker en table Oracle
  conn = conn
)

# Récupérer un aperçu des consultations
consultations_avc_head <- dplyr::tbl(conn, "TMP_CONSULTATIONS_AVC") |>
  head(5) |>
  dplyr::collect()

# Analyser la répartition par spécialité médicale
consultations_par_specialite <- dplyr::tbl(conn, "TMP_CONSULTATIONS_AVC") |>
  dplyr::count(PSE_SPE_COD, sort = TRUE) |>
  dplyr::mutate(pourcentage = round(n / sum(n) * 100, 1)) |>
  dplyr::collect()
kable(head(consultations_par_specialite, 5))

# Analyser le nombre de consultations par patient
consultations_par_patient <- dplyr::tbl(conn, "TMP_CONSULTATIONS_AVC") |>
  dplyr::group_by(BEN_IDT_ANO) |>
  dplyr::summarise(
    nb_consultations = n(),
    premiere_consultation = min(EXE_SOI_DTD, na.rm = TRUE),
    derniere_consultation = max(EXE_SOI_DTD, na.rm = TRUE),
    .groups = "drop"
  ) |>
  dplyr::collect()
```

## Étape 4 : Extraction des Affections de Longue Durée (ALD)

Nous extrayons les ALD des patients avec AVC en utilisant `extract_long_term_disease()`.

```{r extract_ald_avc}

# Extraire les ALD des patients avec AVC
patients_ids_for_ald <- patients_ids_filter |>
  select(BEN_IDT_ANO, BEN_NIR_PSA) |>
  distinct()

extract_long_term_disease(
  start_date = start_date,
  end_date = end_date,
  icd_cod_starts_with = NULL,  # Extraire toutes les ALD
  ald_numbers = NULL,  # Pas de filtre sur numéros ALD
  excl_etm_nat = c("11", "12", "13"),  # Exclure accidents travail/maladies pro
  patients_ids = patients_ids_for_ald,
  output_table_name = "TMP_ALD_AVC",  # Stocker en table Oracle
  overwrite = FALSE,  # Ne pas écraser table existante
  conn = conn
)

# Récupérer un aperçu des ALD
ald_avc_head <- dplyr::tbl(conn, "TMP_ALD_AVC") |>
  head(5) |>
  dplyr::collect()

kable(ald_avc_head)

# Analyser la répartition par type d'ALD
ald_resume <- dplyr::tbl(conn, "TMP_ALD_AVC") |>
  dplyr::count(MED_MTF_COD, sort = TRUE) |>
  dplyr::mutate(pourcentage = round(n / sum(n) * 100, 1)) |>
  arrange(-pourcentage) |>
  dplyr::collect()
kable(head(ald_resume, 5))

# Analyser le pourcentage de patients AVC avec une ALD
patients_avec_ald <- dplyr::tbl(conn, "TMP_ALD_AVC") |>
  dplyr::select(BEN_IDT_ANO) |>
  dplyr::distinct() |>
  dplyr::collect() |>
  nrow()

pourcentage_ald <- round(patients_avec_ald / nrow(patients_avc_qualite) * 100, 1)
print(paste("Pourcentage de patients AVC avec une ALD :", pourcentage_ald, "%"))
```

## Étape 5 : Extraction des prescriptions médicamenteuses

Nous extrayons les délivrances de médicaments des patients avec AVC en utilisant `extract_drug_dispenses()`.

C'est la requête la plus longue sur le portail.
Pour les 122 887 patients hospitalisés pour AVC en 2024, elle tourne en 5 min environ.
Cette lenteur est dûe à la jointure nécessaire entre les deux tables volumineuses `ER_PHA_F` et `ER_PRS_F`.

```{r extract_drug_dispenses_avc}

# Extraire les délivrances de médicaments des patients avec AVC
patients_ids_for_drugs <- patients_ids_filter |>
  select(BEN_IDT_ANO, BEN_NIR_PSA) |>
  distinct()

# Codes ATC pour les médicaments courants post-AVC
# N : système nerveux
# C : système cardiovasculaire
atc_codes_avc <- c("N", "C")

extract_drug_dispenses(
  start_date = start_date,
  end_date = end_date,
  atc_cod_starts_with_filter = atc_codes_avc,  # Médicaments SNC et CV
  cip13_cod_filter = NULL,  # Pas de filtre spécifique CIP13
  patients_ids_filter = patients_ids_for_drugs,
  dis_dtd_lag_months = 6,  # Décalage standard 6 mois
  sup_columns = NULL,  # Pas de colonnes supplémentaires
  output_table_name = "TMP_DRUG_DISPENSES_AVC",  # Stocker en table Oracle
  show_sql_query = FALSE,  # Ne pas afficher requête SQL
  conn = conn
)

# Récupérer un aperçu des délivrances
drugs_avc_head <- dplyr::tbl(conn, "TMP_DRUG_DISPENSES_AVC") |>
  head(5) |>
  dplyr::collect()
kable(drugs_avc_head)

# Analyser la répartition par code ATC
drugs_par_atc <- dplyr::tbl(conn, "TMP_DRUG_DISPENSES_AVC") |>
  dplyr::count(PHA_ATC_CLA, sort = TRUE) |>
  dplyr::mutate(pourcentage = round(n / sum(n) * 100, 1)) |>
  arrange(-pourcentage) |>
  dplyr::collect()
kable(head(drugs_par_atc, 5))
```

## Étape 6 : Nettoyage et fermeture de la session

```{r nettoyage}
# Supprimer les tables temporaires
tables_to_remove <- c("TMP_PATIENTS_AVC_PSA", "TMP_SEJOURS_AVC",
                      "TMP_CONSULTATIONS_AVC", "TMP_ALD_AVC", "TMP_DRUG_DISPENSES_AVC")
for (table_name in tables_to_remove) {
  if (DBI::dbExistsTable(conn, table_name)) {
    DBI::dbRemoveTable(conn, table_name)
  }
}

# Fermer la connexion
DBI::dbDisconnect(conn)
```

## Conclusion

Ce tutoriel a présenté quelques fonctions concernant des étapes d'extraction usuelles à partir du SNDS en utilisant le package `sndsTools`.

La liste complète des fonctions existantes est disponible dans la [documentation du package](https://sndstoolers.github.io/sndsTools/reference/index.html#extraction-snds).
